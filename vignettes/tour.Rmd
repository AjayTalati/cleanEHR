---
title: "A brief tour of cleanEHR"
author: David Perez Suarez & Sinan Shi
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Tour}
  \usepackage[utf8]{inputenc}
---


### Load data 
Usually a RData file which stores all the dataset will be given. A sample RData
can be found in `/doc/sample_ccd.RData`.
```{r}
library(cleanEHR)
data.path <- paste0(find.package("cleanEHR"), "/doc/sample_ccd.RData")
load(data.path)
```
### Data overview
You can have a quick overview of the data by checking `infotb`. In the sample
dataset, sensitive variables such as NHS number and admission time have been
removed or twisted. 
```{r}
print(head(ccd@infotb))
```
The basic entry of the data is episode which indicates an admission of a site.
Using `episode_id` and `site_id` can locate a unique admission entry.  `pid` is
a unique patient identifier. 

```{r}
# quickly check how many episodes are there in the dataset.
ccd@nepisodes
```

There are 263 fields which covers patient demographics, physiology, laboratory,
and medication information. Each field has 2 labels, NHIC code and short name.
There is a function `lookup.items()` to look up the fields you need.
`lookup.items()` function is case insensitive and allows fuzzy search.
```
# searching for heart rate
lookup.items('heart') # fuzzy search

+-------------------+--------------+--------------+--------+-------------+
|     NHIC.Code     |  Short.Name  |  Long.Name   |  Unit  |  Data.type  |
+===================+==============+==============+========+=============+
| NIHR_HIC_ICU_0108 |    h_rate    |  Heart rate  |  bpm   |   numeric   |
+-------------------+--------------+--------------+--------+-------------+
| NIHR_HIC_ICU_0109 |   h_rhythm   | Heart rhythm |  N/A   |    list     |
+-------------------+--------------+--------------+--------+-------------+

```



+-------------------+-------------------------+--------------------------------+----------------+----------------+
|     NHIC.Code     |       Short.Name        |           Long.Name            |      Unit      |   Data.type    |
+===================+=========================+================================+================+================+
| NIHR_HIC_ICU_0002 |          ICNNO          | Site code (ICNARC CMP number)  |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0006 |          bed02          |    CCU bed configuration 02    |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0395 |          bed03          |    CCU bed configuration 03    |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0396 |          bed05          |    CCU bed configuration 05    |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0397 |          bed50          |    CCU bed configuration 90    |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0073 |          NHSNO          |           NHS number           |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0001 |          pasno          |           PAS number           |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0005 |          ADNO           | Critical care local identifier |      N/A       |    numeric     |
|                   |                         |   / ICNARC admission number    |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0033 |           DOB           |         Date of birth          |      N/A       |      date      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0076 |          PCODE          |            Postcode            |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0003 |         GPCODE          |           Code of GP           |      N/A       |      text      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0058 |         ETHNIC          |           Ethnicity            |      N/A       |      list      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0093 |           SEX           |              Sex               |      N/A       |      list      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0017 |           HCM           |             Height             |       cm       |    numeric     |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0018 |         HCMEST          |        Height (Source)         |      N/A       |      list      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0019 |           WKG           |             Weight             |       kg       |    numeric     |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0020 |         WKGEST          |        Weight (Source)         |      N/A       |      list      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0032 |           DAH           |   Date of admission to your    |      N/A       |      date      |
|                   |                         |            hospital            |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0411 |          DAICU          |  Date & Time of admission to   |      N/A       |   date/time    |
|                   |                         |           your unit            |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0050 |          DWFRD          | Date fully ready for discharge |      N/A       |      date      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0051 |          TWFRD          | Time fully ready for discharge |      N/A       |      time      |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0412 |          DDICU          | Date & Time of discharge from  |      N/A       |   date/time    |
|                   |                         |           your unit            |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0037 |         DUDICU          |   Date of ultimate discharge   |      N/A       |      date      |
|                   |                         |          from ICU/HDU          |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0406 |           DDH           |  Date of discharge from your   |      N/A       |      date      |
|                   |                         |            hospital            |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0408 |          DUDH           |   Date of ultimate discharge   |      N/A       |      date      |
|                   |                         |       from your hospital       |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0930 |          UDIS           |  Status at ultimate discharge  |      N/A       |      text      |
|                   |                         |          from ICUHDU           |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+
| NIHR_HIC_ICU_0085 |          RESA           |  Residence prior to admission  |      N/A       |      list      |
|                   |                         |       to acute hospital        |                |                |
+-------------------+-------------------------+--------------------------------+----------------+----------------+






### Inspect individual episode 
```{r, fig.width=10, fig.height=11, out.width='700px', results='hide', message=FALSE, warning=FALSE}
# check the heart rate, bilirubin, fluid balance, and drugs of episode_id = 7. 
# NOTE: due to anonymisation reason, some episodes data cannot be displayed
# properly. 
episode.graph(ccd, 7, c("h_rate",  "bilirubin", "fluid_balance_d"))
```

## Non-longitudinal Data 
`demographic.table()` can generate a `data.table` that contains all the
non-longitudinal variables. A demonstration of how to do some work on a subset
of data.  
```{r, fig.width=10, fig.height=6, out.width='700px', results='hide', message=FALSE, warning=FALSE}
# contains all the 1D fields i.e. non-longitudinal
tb1 <- demographic.table(ccd)

# filter out all dead patient. (All patients are dead in the dataset.)
tb1 <- tb1[DIS=="D"]

# subset variables we want (ARSD = Advanced respiratory support days,
# apache_prob = APACHE II probability)
tb <- tb1[, c("SEX", "ARSD", "apache_prob"), with=FALSE]
tb <- tb[!is.na(apache_prob)]

# plot
library(ggplot2)
ggplot(tb, aes(x=apache_prob, y=ARSD, color=SEX)) + geom_point()

```

## Longitudinal data 
To deal with longitudinal data, we need to first to transform it into a long
table format. 

### Create a `cctable`
```{r}
# To prepare a YAML configuration file like this. You write the following text
# in a YAML file. 
conf <- "
NIHR_HIC_ICU_0108:
  shortName: hrate
NIHR_HIC_ICU_0112:
  shortName: bp_sys_a
  dataItem: Systolic Arterial blood pressure - Art BPSystolic Arterial blood pressure
NIHR_HIC_ICU_0093:
   shortName: sex
"
library(yaml)
tb <- create_cctable(ccd, yaml.load(conf), freq=1)

# a lazy way to do that. 
tb <- create_cctable(ccd, list(NIHR_HIC_ICU_0108=list(), 
                         NIHR_HIC_ICU_0112=list(), 
                         NIHR_HIC_ICU_0093=list()), 
                     freq=1)
print(tb$tclean)
```

### Manipulate on `cctable`
* Get the mean heart rate of each patient. 
```{r}
tb$tclean[, mean(NIHR_HIC_ICU_0108, na.rm=TRUE), by=c("site", "episode_id")]
```


### Data cleaning
To clean the data, one needs to write the specification in the YAML
configuration file. 

```{r, fig.width=12, fig.height=12, out.width='700px', results='hide', message=FALSE, warning=FALSE}
conf <-"
NIHR_HIC_ICU_0108:
  shortName: hrate
  dataItem: Heart rate
  distribution: normal
  decimal_places: 0
  range:
    labels:
      red: (0, 300)
      amber: (11, 150)
    apply: drop_entry
  missingness: # remove episode if missingness is higher than 70% in any 24 hours interval 
    labels:
      yellow: 24
    accept_2d:
      yellow: 70 
    apply: drop_episode
"

ctb <- create_cctable(ccd, yaml.load(conf), freq=1)
ctb$filter_range("amber") # apply range filters
ctb$filter_missingness()
ctb$apply_filters()

cptb <- rbind(cbind(ctb$torigin, data="origin"), 
              cbind(ctb$tclean, data="clean"))


ggplot(cptb, aes(x=time, y=NIHR_HIC_ICU_0108, color=data)) + 
  geom_point(size=1.5) + facet_wrap(~episode_id, scales="free_x")

```
